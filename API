# **API Simples para Conectar ao Oracle da VM - ConfiguraÃ§Ã£o RÃ¡pida no VSCode**

Vou te mostrar o jeito mais direto e prÃ¡tico para criar uma API que conecta sua mÃ¡quina local ao Oracle da VM.

## **ðŸ“Œ PASSO 1: ConfiguraÃ§Ã£o RÃ¡pida da VM (Oracle)**

### **1.1 Permitir conexÃµes externas no Oracle (Execute na VM):**
```bash
# Acesse o SQLPlus como administrador
sqlplus / as sysdba
```

```sql
-- Execute estes comandos SQL:
ALTER SYSTEM SET LOCAL_LISTENER='(ADDRESS=(PROTOCOL=TCP)(HOST=0.0.0.0)(PORT=1521))' SCOPE=BOTH;
ALTER SYSTEM REGISTER;
EXIT;
```

### **1.2 Abrir a porta no firewall (Linux VM):**
```bash
# Execute na VM
sudo firewall-cmd --permanent --add-port=1521/tcp
sudo firewall-cmd --reload
```

### **1.3 Descobrir o IP da VM:**
```bash
ip addr show | grep inet
# Anote o IP (geralmente comeÃ§a com 192.168. ou 10.)
```

---

## **ðŸ“Œ PASSO 2: ConfiguraÃ§Ã£o no VSCode (Sua MÃ¡quina Local)**

### **2.1 Abra o VSCode e crie uma pasta para o projeto**
- `File` â†’ `Open Folder` â†’ Crie uma pasta nova

### **2.2 Crie estes arquivos:**

#### **Arquivo 1: `requirements.txt`**
```txt
fastapi==0.104.1
uvicorn==0.24.0
python-dotenv==1.0.0
cx_Oracle==8.3.0
```

#### **Arquivo 2: `.env`** (configuraÃ§Ãµes)
```env
# Substitua pelos seus dados
ORACLE_HOST=192.168.1.100  # IP da sua VM
ORACLE_PORT=1521
ORACLE_SERVICE=ORCLCDB     # Nome do seu serviÃ§o Oracle
ORACLE_USER=seu_usuario
ORACLE_PASSWORD=sua_senha
```

#### **Arquivo 3: `main.py`** (API principal)
```python
from fastapi import FastAPI, HTTPException
import cx_Oracle
import os
from dotenv import load_dotenv
import uvicorn

# Carrega variÃ¡veis do .env
load_dotenv()

app = FastAPI(title="API Oracle VM", version="1.0")

def get_connection():
    """Cria conexÃ£o com o Oracle da VM"""
    try:
        # Monta a string de conexÃ£o
        dsn = cx_Oracle.makedsn(
            os.getenv("ORACLE_HOST"),
            os.getenv("ORACLE_PORT"),
            service_name=os.getenv("ORACLE_SERVICE")
        )
        
        # Conecta ao banco
        connection = cx_Oracle.connect(
            user=os.getenv("ORACLE_USER"),
            password=os.getenv("ORACLE_PASSWORD"),
            dsn=dsn
        )
        return connection
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Erro na conexÃ£o: {str(e)}")

@app.get("/")
def home():
    """PÃ¡gina inicial da API"""
    return {
        "message": "API Oracle VM Funcionando!",
        "endpoints": {
            "/teste-conexao": "Testa conexÃ£o com Oracle",
            "/tables": "Lista tabelas do usuÃ¡rio",
            "/query/{sql}": "Executa SQL (usar %20 para espaÃ§os)"
        }
    }

@app.get("/teste-conexao")
def teste_conexao():
    """Testa se consegue conectar ao Oracle da VM"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT 'ConexÃ£o OK!' as status FROM dual")
        result = cursor.fetchone()
        cursor.close()
        conn.close()
        
        return {
            "status": "success",
            "message": "ConexÃ£o com Oracle estabelecida com sucesso!",
            "data": result[0]
        }
    except Exception as e:
        return {
            "status": "error",
            "message": f"Falha na conexÃ£o: {str(e)}",
            "dica": "Verifique: 1) IP da VM, 2) Oracle rodando, 3) Firewall aberto"
        }

@app.get("/tables")
def listar_tabelas():
    """Lista todas as tabelas do usuÃ¡rio"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        
        cursor.execute("""
            SELECT table_name, num_rows 
            FROM user_tables 
            ORDER BY table_name
        """)
        
        tabelas = []
        for row in cursor:
            tabelas.append({
                "table_name": row[0],
                "num_rows": row[1] if row[1] else 0
            })
        
        cursor.close()
        conn.close()
        
        return {
            "status": "success",
            "count": len(tabelas),
            "tables": tabelas
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/query/{sql}")
def executar_query(sql: str):
    """Executa uma query SQL (use %20 para espaÃ§os na URL)"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        
        # Decodifica espaÃ§os (%20) e outros caracteres
        import urllib.parse
        sql_decoded = urllib.parse.unquote(sql)
        
        # Executa a query
        cursor.execute(sql_decoded)
        
        # Pega nomes das colunas
        col_names = [col[0] for col in cursor.description]
        
        # Pega resultados
        results = []
        for row in cursor:
            results.append(dict(zip(col_names, row)))
        
        cursor.close()
        conn.close()
        
        return {
            "status": "success",
            "query": sql_decoded,
            "columns": col_names,
            "results": results,
            "row_count": len(results)
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

if __name__ == "__main__":
    uvicorn.run(
        "main:app",
        host="0.0.0.0",  # Permite acesso de qualquer IP da rede
        port=8000,
        reload=True  # Reinicia automaticamente ao salvar
    )
```

---

## **ðŸ“Œ PASSO 3: InstalaÃ§Ã£o e ExecuÃ§Ã£o no VSCode**

### **3.1 Abra o terminal no VSCode:**
- `Terminal` â†’ `New Terminal`

### **3.2 Instale as dependÃªncias:**
```bash
pip install -r requirements.txt
```

### **3.3 Configure o Instant Client (ObrigatÃ³rio para Windows/Mac):**
1. **Baixe o Oracle Instant Client:** https://www.oracle.com/database/technologies/instant-client/downloads.html
2. **Escolha a versÃ£o bÃ¡sica (Basic)**
3. **Extraia em:** `C:\oracle\instantclient` (Windows) ou `/opt/oracle/instantclient` (Linux/Mac)
4. **Adicione ao PATH** ou configure no cÃ³digo:

**Adicione no inÃ­cio do `main.py` (antes de importar cx_Oracle):**
```python
import os
# Para Windows (ajuste o caminho)
os.environ["PATH"] = r"C:\oracle\instantclient_21_12;" + os.environ["PATH"]

# Para Linux/Mac
# os.environ["LD_LIBRARY_PATH"] = "/opt/oracle/instantclient_21_12"
```

### **3.4 Execute a API:**
```bash
python main.py
```

Ou crie um arquivo `start.bat` (Windows) ou `start.sh` (Linux):
```batch
@echo off
python main.py
```

---

## **ðŸ“Œ PASSO 4: Testando a API**

### **4.1 Acesse no navegador:**
```
http://localhost:8000
```

### **4.2 Teste a conexÃ£o:**
```
http://localhost:8000/teste-conexao
```

### **4.3 Veja as tabelas:**
```
http://localhost:8000/tables
```

### **4.4 Execute uma query:**
```
http://localhost:8000/query/SELECT%20*%20FROM%20dual
```

---

## **ðŸ“Œ PASSO 5: Use a API no Seu CÃ³digo (Exemplo)**

### **Python:**
```python
import requests

# Teste conexÃ£o
response = requests.get("http://localhost:8000/teste-conexao")
print(response.json())

# Executa query
query = "SELECT username FROM all_users"
response = requests.get(f"http://localhost:8000/query/{query}")
print(response.json())
```

### **JavaScript (Node.js):**
```javascript
const axios = require('axios');

axios.get('http://localhost:8000/tables')
  .then(response => console.log(response.data))
  .catch(error => console.error(error));
```

---

## **ðŸ”§ SoluÃ§Ã£o de Problemas Comuns:**

### **Erro: "DPI-1047: Cannot locate a 64-bit Oracle Client library"**
- **SoluÃ§Ã£o:** Instale o Oracle Instant Client (Passo 3.3)

### **Erro: "Connection refused"**
- **SoluÃ§Ã£o:**
  1. Verifique se a VM estÃ¡ ligada
  2. Verifique o IP da VM: `ip addr show` (Linux) ou `ipconfig` (Windows)
  3. Teste a porta: `telnet IP_DA_VM 1521`
  4. Verifique firewall na VM

### **Erro: "ORA-12541: TNS:no listener"**
- **SoluÃ§Ã£o:** Na VM, execute:
  ```bash
  lsnrctl start
  ```

---

## **ðŸŽ¯ Estrutura Final do Projeto:**
```
meu-projeto-oracle/
â”œâ”€â”€ .env
â”œâ”€â”€ main.py
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ start.bat (ou start.sh)
â””â”€â”€ README.md
```

## **ðŸ’¡ Dica RÃ¡pida:**
Se precisar testar rapidamente sem criar API, use este cÃ³digo simples:

```python
import cx_Oracle
import os

# ConfiguraÃ§Ã£o direta
connection = cx_Oracle.connect(
    user="seu_usuario",
    password="sua_senha",
    dsn="IP_DA_VM:1521/ORCLCDB"
)

cursor = connection.cursor()
cursor.execute("SELECT * FROM dual")
print(cursor.fetchall())
```

**Pronto!** Agora vocÃª tem uma API funcionando que conecta sua mÃ¡quina local ao Oracle da VM. A API jÃ¡ estÃ¡ configurada para desenvolvimento no VSCode com hot-reload (atualiza automaticamente quando vocÃª salva).
