import os
import pandas as pd
import oracledb
import re

print("INICIANDO IMPORTADOR CSV PARA ORACLE")
print("=" * 50)

# Configurações
ORACLE_USER = "custodia"
ORACLE_PASSWORD = "MVPCustodia2025"
ORACLE_DSN = "localhost:1522/XEPDB1"
CSV_FOLDER = "C:/Users/thatyane_soares/OneDrive - Sicredi/Documents/Projeto/csv_files"

print(f"Usuario: {ORACLE_USER}")
print(f"DSN: {ORACLE_DSN}")
print(f"Pasta CSV: {CSV_FOLDER}")
print("-" * 30)

def test_oracle_connection():
    print("Testando conexao com Oracle...")
    try:
        connection = oracledb.connect(
            user=ORACLE_USER,
            password=ORACLE_PASSWORD,
            dsn=ORACLE_DSN
        )
        cursor = connection.cursor()
        cursor.execute("SELECT 'Conexao OK' FROM DUAL")
        result = cursor.fetchone()
        cursor.close()
        connection.close()
        print(f"Conexao bem sucedida: {result[0]}")
        return True
    except Exception as e:
        print(f"Falha na conexao: {e}")
        return False

def clean_name(name):
    name = str(name).lower().replace(' ', '_')
    name = re.sub(r'[^a-zA-Z0-9_]', '', name)
    name = re.sub(r'_+', '_', name)
    return name.strip('_')

def get_oracle_datatype(dtype, sample_data=None):
    dtype_str = str(dtype)
    
    if 'int' in dtype_str:
        return 'NUMBER'
    elif 'float' in dtype_str:
        return 'NUMBER(15,6)'
    elif 'datetime' in dtype_str:
        return 'DATE'
    elif 'object' in dtype_str:
        if sample_data is not None and hasattr(sample_data, 'str'):
            max_len = sample_data.str.len().max()
            if pd.isna(max_len) or max_len < 1:
                return 'VARCHAR2(500)'
            return f'VARCHAR2({min(int(max_len) * 2, 4000)})'
        return 'VARCHAR2(500)'
    else:
        return 'VARCHAR2(500)'

def import_csv_to_oracle():
    # Verificar pasta
    if not os.path.exists(CSV_FOLDER):
        print(f"ERRO: Pasta nao encontrada: {CSV_FOLDER}")
        return
    
    # Buscar arquivos CSV
    csv_files = []
    for file in os.listdir(CSV_FOLDER):
        if file.lower().endswith('.csv'):
            csv_files.append(file)
    
    print(f"Arquivos CSV encontrados: {len(csv_files)}")
    for file in csv_files:
        print(f"  - {file}")
    
    if not csv_files:
        print("Nenhum arquivo CSV encontrado para importar")
        return
    
    # Testar conexao
    if not test_oracle_connection():
        print("Importacao cancelada - problemas de conexao")
        return
    
    # Conectar ao Oracle
    print("Conectando ao Oracle Database...")
    try:
        connection = oracledb.connect(
            user=ORACLE_USER,
            password=ORACLE_PASSWORD,
            dsn=ORACLE_DSN
        )
        cursor = connection.cursor()
        print("Conexao estabelecida com sucesso")
    except Exception as e:
        print(f"Erro de conexao: {e}")
        return
    
    # Processar cada arquivo
    print("\nPROCESSANDO ARQUIVOS:")
    print("=" * 50)
    
    total_success = 0
    total_failed = 0
    
    for csv_file in csv_files:
        print(f"\nProcessando: {csv_file}")
        file_path = os.path.join(CSV_FOLDER, csv_file)
        
        try:
            # Ler CSV
            print("  Lendo arquivo...")
            try:
                df = pd.read_csv(file_path, low_memory=False)
            except UnicodeDecodeError:
                df = pd.read_csv(file_path, encoding='ISO-8859-1', low_memory=False)
            
            if df.empty:
                print("  AVISO: Arquivo vazio - ignorando")
                total_failed += 1
                continue
            
            print(f"  Linhas: {len(df):,}, Colunas: {len(df.columns)}")
            
            # Preparar nome da tabela
            table_name = clean_name(csv_file.replace('.csv', ''))
            df.columns = [clean_name(col) for col in df.columns]
            
            # Criar schema
            print("  Criando schema da tabela...")
            columns_schema = []
            for col in df.columns:
                sample_data = df[col] if df[col].dtype == 'object' else None
                oracle_type = get_oracle_datatype(df[col].dtype, sample_data)
                columns_schema.append(f'"{col}" {oracle_type}')
            
            # Dropar tabela se existir
            try:
                cursor.execute(f'DROP TABLE "{table_name}"')
                connection.commit()
                print(f"  Tabela existente removida: {table_name}")
            except:
                connection.rollback()
            
            # Criar tabela
            columns_schema_str = ', '.join(columns_schema)
            cursor.execute(f'CREATE TABLE "{table_name}" ({columns_schema_str})')
            connection.commit()
            print(f"  Tabela criada: {table_name}")
            
            # Preparar dados para insercao
            print("  Preparando dados para insercao...")
            data_tuples = []
            for row in df.itertuples(index=False):
                cleaned_row = []
                for value in row:
                    cleaned_row.append(None if pd.isna(value) else value)
                data_tuples.append(tuple(cleaned_row))
            
            # Inserir dados
            print("  Inserindo dados no banco...")
            placeholders = ', '.join([':' + str(i+1) for i in range(len(df.columns))])
            insert_sql = f'INSERT INTO "{table_name}" VALUES ({placeholders})'
            
            batch_size = 1000
            total_rows = len(data_tuples)
            inserted_rows = 0
            
            for i in range(0, total_rows, batch_size):
                batch = data_tuples[i:i + batch_size]
                try:
                    cursor.executemany(insert_sql, batch)
                    connection.commit()
                    inserted_rows += len(batch)
                except Exception as batch_error:
                    print(f"  Erro no lote: {batch_error}")
                    connection.rollback()
                    
                    # Tentar linha por linha
                    for row in batch:
                        try:
                            cursor.execute(insert_sql, row)
                            inserted_rows += 1
                        except:
                            pass
                    connection.commit()
            
            print(f"  Dados inseridos: {inserted_rows:,}/{total_rows:,} linhas")
            
            if inserted_rows > 0:
                total_success += 1
                print(f"  SUCESSO: {csv_file} importado")
            else:
                total_failed += 1
                print(f"  FALHA: Nenhum dado inserido de {csv_file}")
            
        except Exception as e:
            total_failed += 1
            print(f"  ERRO ao processar {csv_file}: {e}")
            connection.rollback()
    
    # Finalizacao
    print("\n" + "=" * 50)
    print("RESULTADO FINAL DA IMPORTACAO")
    print("-" * 30)
    print(f"Total de arquivos: {len(csv_files)}")
    print(f"Importados com sucesso: {total_success}")
    print(f"Falhas: {total_failed}")
    
    cursor.close()
    connection.close()
    print("Conexao com Oracle fechada")

if __name__ == "__main__":
    print("\nIniciando processo de importacao...")
    print("-" * 30)
    import_csv_to_oracle()
    print("\nProcesso finalizado")
    print("=" * 50)
